using MixerChatApp.Core.APIs;
using MixerChatApp.Core.Interfaces;
using MixerChatApp.Core.Models;
using Newtonsoft.Json;
using Prism.Commands;
using Prism.Mvvm;
using Prism.Regions;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.Threading.Tasks;
using System.Windows;
using Unity;

namespace MixerChatApp.Core.ViewModels
{
    public class MixerSettingViewModel : BindableBase
    {
        //ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*
        #region // プロパティ
        /// <summary>ユーザー名 を取得、設定</summary>
        private string userName_;
        /// <summary>ユーザー名 を取得、設定</summary>
        public string UserName
        {
            get => this.userName_;

            set => this.SetProperty(ref this.userName_, value);
        }

        /// <summary>説明 を取得、設定</summary>
        private DateTimeOffset connectDate_;
        /// <summary>説明 を取得、設定</summary>
        public DateTimeOffset ConnectDate
        {
            get => this.connectDate_;

            set => this.SetProperty(ref this.connectDate_, value);
        }

        /// <summary>説明 を取得、設定</summary>
        private string connectDateString_;
        /// <summary>説明 を取得、設定</summary>
        public string ConnectDateString
        {
            get => this.connectDateString_;

            set => this.SetProperty(ref this.connectDateString_, value);
        }

        /// <summary>説明 を取得、設定</summary>
        private bool isSaveUserInformation_;
        /// <summary>説明 を取得、設定</summary>
        public bool IsSaveUserInformation
        {
            get => this.isSaveUserInformation_;

            set => this.SetProperty(ref this.isSaveUserInformation_, value);
        }
        #endregion
        //ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*
        #region // コマンド
        private DelegateCommand createTokensCommand_;
        public DelegateCommand CreateTokensCommand =>
            createTokensCommand_ ?? (createTokensCommand_ = new DelegateCommand(ExecuteCreateTokensCommand));

        async void ExecuteCreateTokensCommand()
        {
            await this._oAuthManager.RunAsync();
        }
        #endregion
        //ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*
        #region // コマンド用メソッド
        #endregion
        //ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*
        #region // オーバーライドメソッド
        protected override void OnPropertyChanged(PropertyChangedEventArgs args)
        {
            base.OnPropertyChanged(args);
            if (args.PropertyName == nameof(this.IsSaveUserInformation)) {
                this._domain.IsSaveUserInformation = this.IsSaveUserInformation;
            }
            else if (args.PropertyName == nameof(this.ConnectDate)) {
                this.ConnectDateString = $"{this.ConnectDate.DateTime:yyyy/MM/dd HH:mm:ss.fffff}";
            }
        }
        #endregion
        //ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*
        #region // パブリックメソッド
        [InjectionMethod]
        public async void Init()
        {
            WeakEventManager<INotifyPropertyChanged, PropertyChangedEventArgs>.AddHandler(
                this._oAuthManager, nameof(INotifyPropertyChanged.PropertyChanged), this.OnManagerPropertyChanged);
            try {
                if (this._oAuthManager.Tokens != null) {
                    this.UserName = await _aPI.GetUserName(this._oAuthManager.Tokens.AccessToken);
                    this.ConnectDate = this._oAuthManager.Tokens.ExpiresAt;
                }
            }
            catch (Exception e) {
                Debug.WriteLine($"{e}");
                throw;
            }
            this.IsSaveUserInformation = this._domain.IsSaveUserInformation;
        }
        #endregion
        //ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*
        #region // プライベートメソッド
        private void OnManagerPropertyChanged(object sender, PropertyChangedEventArgs e)
        {
            if (sender is IOAuthManagerable manager && e.PropertyName == nameof(manager.Tokens)) {
                this.UserName = manager.UserName;
                this.ConnectDate = manager.Tokens.ExpiresAt;
            }
        }
        #endregion
        //ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*
        #region // メンバ変数
        [Dependency]
        public IOAuthManagerable _oAuthManager;
        [Dependency]
        public MixerAPI _aPI;
        [Dependency]
        public ISettingDomain _domain;
        #endregion
        //ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*ﾟ+｡｡+ﾟ*｡+ﾟ ﾟ+｡*
        #region // 構築・破棄
        public MixerSettingViewModel()
        {

        }
        #endregion
    }
}
